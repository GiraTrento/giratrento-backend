openapi: 3.0.0
info:
  title: GiraTrento API
  description: Backend API per il progetto GiraTrento Sostenibile (Node.js + MongoDB).
  version: 1.0.0
servers:
  - url: http://localhost:3000/api
    description: Server di Sviluppo Locale
  - url: https://giratrento-backend.onrender.com/api
    description: Server di deploy delle API

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [user, merchant, admin]

    Activity:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        description:
          type: string
        category:
          type: string
        location:
          type: object
          properties:
            type: { type: string, default: Point }
            coordinates:
              type: array
              items: { type: number }
        owner:
          type: string
        isApproved:
          type: boolean
        products:
          type: array
          items:
            $ref: '#/components/schemas/Product'
        reviews:
          type: array
          items:
            $ref: '#/components/schemas/Review'

    Product:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        price:
          type: number
        available:
          type: boolean

    Review:
      type: object
      properties:
        user:
          type: string
        rating:
          type: number
        comment:
          type: string
        date:
          type: string
          format: date-time

    Order:
      type: object
      properties:
        _id:
          type: string
        user:
          type: string
        activity:
          type: string
        items:
          type: array
          items:
            type: object
            properties:
              name: { type: string }
              price: { type: number }
              quantity: { type: integer }
        totalAmount:
          type: number
        status:
          type: string
          enum: [pending, confirmed, completed]
        pickupDate:
          type: string
          format: date-time

paths:
  # --- AUTHENTICATION ---
  /auth/register:
    post:
      summary: Registrazione nuovo utente base
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email, password]
              properties:
                name: { type: string }
                email: { type: string, format: email }
                password: { type: string }
      responses:
        '201':
          description: Utente creato con successo

  /auth/login:
    post:
      summary: Login utente e rilascio Token
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string }
                password: { type: string }
      responses:
        '200':
          description: Login effettuato

  # --- ACTIVITIES ---
  /activities:
    get:
      summary: Ottieni lista attività approvate
      tags: [Activities]
      responses:
        '200':
          description: OK
    post:
      summary: Suggerisci una nuova attività
      tags: [Activities]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                category: { type: string }
                address: { type: string }
                location:
                  type: object
                  properties:
                    type: { type: string }
                    coordinates: 
                      type: array
                      items: { type: number }
      responses:
        '201':
          description: Creato

  /activities/{id}/reviews:
    post:
      summary: Aggiungi recensione
      tags: [Activities]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                rating: { type: number }
                comment: { type: string }
      responses:
        '200':
          description: OK

  # --- MERCHANT DASHBOARD ---
  /merchant/activities:
    get:
      summary: Ottieni le attività del negoziante
      tags: [Merchant]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Lista attività del merchant

  /activities/{id}/orders:
    get:
      summary: Ottieni ordini ricevuti dall'attività
      tags: [Merchant]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Lista ordini dell'attività

  # --- PRODUCTS ---
  /activities/{id}/products:
    post:
      summary: Aggiungi prodotto
      tags: [Products]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                price: { type: number }
                available: { type: boolean }
      responses:
        '200':
          description: OK

  /activities/{id}/products/{productId}:
    put:
      summary: Modifica prodotto
      tags: [Products]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - in: path
          name: productId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                price: { type: number }
                available: { type: boolean }
      responses:
        '200':
          description: OK
    delete:
      summary: Elimina prodotto
      tags: [Products]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - in: path
          name: productId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK

  # --- ADMIN PANEL ---
  /admin/pending:
    get:
      summary: Lista attività da approvare
      tags: [Admin]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK

  /admin/approve/{id}:
    put:
      summary: Approva un'attività
      tags: [Admin]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK

  /admin/activity/{id}:
    put:
      summary: Modifica attività
      tags: [Admin]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Activity'
      responses:
        '200':
          description: OK
    delete:
      summary: Elimina attività
      tags: [Admin]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK

  /admin/users:
    get:
      summary: Lista utenti registrati
      tags: [Admin]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK

  /admin/users/{id}/role:
    put:
      summary: Cambia ruolo utente
      tags: [Admin]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role: { type: string, enum: [user, merchant, admin] }
      responses:
        '200':
          description: OK

  # --- ORDERS ---
  /orders:
    get:
      summary: I miei ordini
      tags: [Orders]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
    post:
      summary: Crea ordine
      tags: [Orders]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Order'
      responses:
        '201':
          description: Creato
