openapi: 3.0.0
info:
  title: GiraTrento API
  description: Backend API per il progetto GiraTrento Sostenibile (Node.js + MongoDB). Gestisce autenticazione, attività geolocalizzate, ordini e pannello admin.
  version: 1.0.0
servers:
  - url: http://localhost:3000/api
    description: Server di Sviluppo Locale

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          example: "60d0fe4f5311236168a109ca"
        name:
          type: string
          example: "Mario Rossi"
        email:
          type: string
          format: email
          example: "mario@email.com"
        role:
          type: string
          enum: [user, merchant, admin]
          example: "user"

    Activity:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
          example: "Trento Sfuso"
        description:
          type: string
        category:
          type: string
          enum: [Riparazioni, Sfuso, Alimentari Locali, Seconda Mano, Artigianato Locale]
        location:
          type: object
          properties:
            type:
              type: string
              example: "Point"
            coordinates:
              type: array
              items:
                type: number
              example: [11.12108, 46.06787] # [Lng, Lat]
        isApproved:
          type: boolean
        products:
          type: array
          items:
            $ref: '#/components/schemas/Product'
        reviews:
          type: array
          items:
            $ref: '#/components/schemas/Review'

    Product:
      type: object
      properties:
        name:
          type: string
          example: "Cesto Bio"
        price:
          type: number
          example: 15.50
        available:
          type: boolean
          default: true

    Review:
      type: object
      properties:
        user:
          type: string
        rating:
          type: number
          minimum: 1
          maximum: 5
        comment:
          type: string
        date:
          type: string
          format: date-time

    Order:
      type: object
      properties:
        _id:
          type: string
        user:
          type: string
        activity:
          $ref: '#/components/schemas/Activity'
        items:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              quantity:
                type: integer
        totalAmount:
          type: number
        status:
          type: string
          enum: [pending, confirmed, completed]
        pickupDate:
          type: string
          format: date-time

paths:
  /auth/register:
    post:
      summary: Registrazione nuovo utente
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email, password]
              properties:
                name: { type: string }
                email: { type: string, format: email }
                password: { type: string }
                role: { type: string, enum: [user, merchant, admin] }
      responses:
        '201':
          description: Utente creato con successo
        '400':
          description: Dati non validi o email già esistente

  /auth/login:
    post:
      summary: Login utente e rilascio Token JWT
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string }
                password: { type: string }
      responses:
        '200':
          description: Login effettuato
          content:
            application/json:
              schema:
                type: object
                properties:
                  token: { type: string }
                  user: { $ref: '#/components/schemas/User' }
        '401':
          description: Credenziali errate

  /activities:
    get:
      summary: Ottieni lista attività (con filtri Geo e Categoria)
      tags: [Activities]
      parameters:
        - in: query
          name: category
          schema: { type: string }
          description: Filtra per categoria (es. Sfuso)
        - in: query
          name: lat
          schema: { type: number }
          description: Latitudine utente
        - in: query
          name: lng
          schema: { type: number }
          description: Longitudine utente
        - in: query
          name: dist
          schema: { type: integer }
          description: Raggio di ricerca in metri (default 5000)
      responses:
        '200':
          description: Lista delle attività approvate
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Activity'

    post:
      summary: Suggerisci una nuova attività
      tags: [Activities]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, category, location]
              properties:
                name: { type: string }
                description: { type: string }
                category: { type: string }
                address: { type: string }
                location:
                  type: object
                  properties:
                    type: { type: string, default: Point }
                    coordinates: 
                      type: array
                      items: { type: number }
                      description: "[Longitudine, Latitudine]"
      responses:
        '201':
          description: Attività creata (in attesa di approvazione)

  /activities/{id}/products:
    post:
      summary: Aggiungi prodotto alla vetrina (Solo Merchant/Owner)
      tags: [Activities]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Product'
      responses:
        '200':
          description: Prodotto aggiunto

  /activities/{id}/reviews:
    post:
      summary: Aggiungi recensione
      tags: [Activities]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                rating: { type: number }
                comment: { type: string }
      responses:
        '200':
          description: Recensione aggiunta

  /admin/pending:
    get:
      summary: Lista attività in attesa di approvazione
      tags: [Admin]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Lista attività non approvate
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Activity'

  /admin/approve/{id}:
    put:
      summary: Approva un'attività
      tags: [Admin]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Attività approvata e visibile

  /admin/activity/{id}:
    delete:
      summary: Rifiuta/Elimina un'attività
      tags: [Admin]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Attività eliminata

  /orders:
    get:
      summary: I miei ordini
      tags: [Orders]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Storico ordini utente
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Order'

    post:
      summary: Crea una prenotazione
      tags: [Orders]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                activityId: { type: string }
                items:
                  type: array
                  items:
                    type: object
                    properties:
                      name: { type: string }
                      price: { type: number }
                      quantity: { type: number }
                totalAmount: { type: number }
                pickupDate: { type: string, format: date-time }
      responses:
        '201':
          description: Ordine creato
